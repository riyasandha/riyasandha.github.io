<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Passport Photo A4 Maker with Crop + Border</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
<style>
  body{font-family:Arial, sans-serif; padding:20px; background:#f4f6f9; text-align:center}
  .card{background:#fff; padding:16px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.1); margin:auto; max-width:500px}
  label{display:block; margin:10px 0 4px; font-weight:bold}
  input, select{padding:6px; border-radius:6px; border:1px solid #ccc; width:100%}
  button{margin:8px; padding:10px 16px; border:none; border-radius:8px; cursor:pointer; font-weight:bold}
  button.primary{background:#22c55e; color:white}
  button.secondary{background:#ddd}
  canvas{max-width:100%; margin-top:12px; border:1px solid #ccc; background:#fff}
  #cropContainer{display:none; margin:10px 0;}
  #cropPreview{max-width:100%;}
</style>
</head>
<body>
<div class="card">
  <h2>Passport Photo → A4 Page</h2>
  <label>Upload Photo</label>
  <input type="file" id="file" accept="image/*">

  <div id="finalPreviewContainer" style="display:none; margin-top:10px;">
  <p>Cropped Preview:</p>
  <img id="finalPreview" style="max-width:150px; border:1px solid #ccc; padding:4px;">
</div>

  <!-- Crop UI -->
  <div id="cropContainer">
    <p>Adjust crop, then click "Confirm Crop".</p>
    <img id="cropPreview">
    <button class="primary" id="confirmCrop">Confirm Crop</button>
  </div>

  <label>Choose Standard Size</label>
  <select id="preset">
    <option value="">-- Custom --</option>
    <option value="35x45">35×45 mm (Standard Passport)</option>
    <option value="50x50">50×50 mm (US Passport)</option>
    <option value="25x35">25×35 mm (Visa)</option>
    <option value="40x60">40×60 mm</option>
  </select>
  
  <label>Photo Width (mm)</label>
  <input type="number" id="wmm" value="35" step="0.1">
  
  <label>Photo Height (mm)</label>
  <input type="number" id="hmm" value="45" step="0.1">
  
  <label>Spacing between photos (mm)</label>
  <input type="number" id="gap" value="3" step="0.1">

  <label>Number of Photos (leave 0 to auto-fill)</label>
  <input type="number" id="count" value="0" min="0">

  <button class="primary" id="gen">Generate A4 Sheet</button>
  <button class="secondary" id="dlPdf" disabled>Download PDF</button>
  <button class="secondary" id="dlPng" disabled>Download PNG</button>
  
  <canvas id="sheetCanvas"></canvas>
</div>

<script>
(() => {
  const A4 = {wmm:210, hmm:297};
  const DPI = 300; 
  const mmToPx = mm => Math.round(mm * DPI / 25.4);

  const file = document.getElementById('file');
  const genBtn = document.getElementById('gen');
  const dlPdf = document.getElementById('dlPdf');
  const dlPng = document.getElementById('dlPng');
  const canvas = document.getElementById('sheetCanvas');
  const ctx = canvas.getContext('2d');
  const preset = document.getElementById('preset');
  const wmmInput = document.getElementById('wmm');
  const hmmInput = document.getElementById('hmm');
  const countInput = document.getElementById('count');

  const cropContainer = document.getElementById('cropContainer');
  const cropPreview = document.getElementById('cropPreview');
  const confirmCropBtn = document.getElementById('confirmCrop');

  let img = null, latestBlob=null;
  let cropper = null;

  // handle presets
  preset.addEventListener('change', ()=>{
    if(!preset.value) return; 
    const [w,h] = preset.value.split('x').map(Number);
    wmmInput.value = w;
    hmmInput.value = h;
  });

  file.addEventListener('change', e=>{
    const f = e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    cropPreview.src = url;
    cropContainer.style.display = "block";
    if(cropper) cropper.destroy();
    cropper = new Cropper(cropPreview, {
      aspectRatio: NaN, 
      viewMode: 1
    });
  });
confirmCropBtn.addEventListener('click', ()=>{
  if(!cropper) return;
  const croppedCanvas = cropper.getCroppedCanvas();

  // main working image
  img = new Image();
  img.src = croppedCanvas.toDataURL("image/jpeg", 0.9);

  // show cropped preview
  const previewCanvas = document.getElementById('croppedPreviewCanvas');
  const ctxPrev = previewCanvas.getContext('2d');
  previewCanvas.width = croppedCanvas.width;
  previewCanvas.height = croppedCanvas.height;
  ctxPrev.clearRect(0,0,previewCanvas.width, previewCanvas.height);
  ctxPrev.drawImage(croppedCanvas,0,0);

  document.getElementById('previewBox').style.display = "block";
  cropContainer.style.display = "none";
});

  genBtn.addEventListener('click', ()=>{
    if(!img) return alert("Upload & crop a photo first!");

    const wmm = +wmmInput.value;
    const hmm = +hmmInput.value;
    const gapmm = +document.getElementById('gap').value;
    const desiredCount = +countInput.value;

    const pw = mmToPx(A4.wmm);
    const ph = mmToPx(A4.hmm);
    canvas.width = pw; canvas.height = ph;

    ctx.fillStyle = "#ffffff";
    ctx.fillRect(0,0,pw,ph);

    const iw = mmToPx(wmm);
    const ih = mmToPx(hmm);
    const gap = mmToPx(gapmm);

    let perRow = Math.floor((pw + gap) / (iw + gap));
    let perCol = Math.floor((ph + gap) / (ih + gap));
    let maxPhotos = perRow * perCol;

    let totalPhotos = desiredCount > 0 ? Math.min(desiredCount, maxPhotos) : maxPhotos;

    let rows = Math.ceil(totalPhotos / perRow);
    let startX = Math.floor((pw - (perRow*iw + (perRow-1)*gap)) / 2);
    let startY = Math.floor((ph - (rows*ih + (rows-1)*gap)) / 2);

    let photoIndex = 0;
    for(let r=0;r<rows;r++){
      for(let c=0;c<perRow;c++){
        if(photoIndex >= totalPhotos) break;
        const x = startX + c*(iw+gap);
        const y = startY + r*(ih+gap);

        // draw image
        ctx.drawImage(img, x, y, iw, ih);

        // draw black border
        ctx.strokeStyle = "black";
        ctx.lineWidth = 1;
        ctx.strokeRect(x, y, iw, ih);

        photoIndex++;
      }
    }

    canvas.toBlob(b=>{
      latestBlob = b;
      dlPdf.disabled = false;
      dlPng.disabled = false;
    },'image/jpeg',0.95);
  });

  dlPng.addEventListener('click', ()=>{
    if(!latestBlob) return;
    const url = URL.createObjectURL(latestBlob);
    const a = document.createElement('a');
    a.href = url; a.download = "passport-sheet-a4.png"; a.click();
    URL.revokeObjectURL(url);
  });

  dlPdf.addEventListener('click', async ()=>{
    if(!latestBlob) return;
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({unit:'mm', format:'a4'});
    const dataUrl = await blobToDataURL(latestBlob);
    pdf.addImage(dataUrl,'JPEG',0,0,A4.wmm,A4.hmm);
    pdf.save("passport-sheet-a4.pdf");
  });

  function blobToDataURL(blob){
    return new Promise(res=>{
      const r = new FileReader();
      r.onload=()=>res(r.result);
      r.readAsDataURL(blob);
    });
  }
})();
</script>
</body>
</html>
